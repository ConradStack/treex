#!/usr/bin/env perl

use Mojolicious::Lite;
use Treex::Core::Config;
use Treex::Service::Manager;

helper service_manager => sub {
  state $service_manager = Treex::Service::Manager->new();
};

get '/' => sub {
  my $self = shift;

  return $self->render(json => {
    modules => [keys %{$self->service_manager->modules}]
  });
};

post '/service/:module' => sub {
  my $self = shift;

  my $module = $self->param('module');
  my $init_args = $self->req->query_params->to_hash;

  my $service = $self->service_manager->get_service($module, $init_args);

  return $self->render(json => $service->process($self->req->json));
};

app->start;
